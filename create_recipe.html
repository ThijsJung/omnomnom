<!DOCTYPE html>
<html>
    <head lang="en">
        <title>Omnomnom</title>
        <meta charset="utf-8" />
    </head>
    <body>
        <div>
            <a href="index.html"><h1>Omnomnom</h1></a>
        </div>
        <div>
            <form id="recipeForm">
                <h3>Recipe details</h3>
                <div>
                    <label for="recipeTitle">Title:</label>
                    <input class="recipeDetails" name="recipeTitle" data-attribute_name="title">
                </div>
                <div>
                    <label for="recipeDescription">Description:</label>
                    <textarea cols="30" rows="8" class="recipeDetails" name="recipeDescription" data-attribute_name="description"></textarea>
                </div>
                <div>
                    <label for="preparationTime">Preparation time (hour:minute):</label>
                    <input class="recipeDetails" name="preparationTime" data-attribute_name="prep_time" type="time">
                </div>
                <div>
                    <label for="CookTime">Cooking time (hour:minute)</label>
                    <input class="recipeDetails" name="CookTime" data-attribute_name="cook_time" type="time">
                </div>
                <div>
                    <label for="hungryPeopleCount">Number of portions:</label>
                    <input class="recipeDetails" name="hungryPeopleCount" data-attribute_name="portion_size" type="number">
                </div>
                <div>
                    <label for="recipeImage">Add picture</label>
                    <input name="recipeImage" data-attribute_name="image_url" type="file">
                </div>
                <div>
                    <h3>Ingredients</h3>
                    <ul id="ingredient_list"></ul>
                    <button type="button" id="add_ingredient_button">Add ingredient</button>
                    <h3>Preparation</h3>
                    <ol id="preparation"></ol>
                    <button type="button" id="add_preparation_button">Add ingredient</button>
                    <h3>Protips</h3>
                    <ul id="pro_tips"></ul>
                    <button type="button" id="add_pro_tip_button">Add ingredient</button>
                </div>
                <input type="submit" value="Save">
            </form>
        </div>
        <div id="result"></div>

        <template id="ingredient">
            <li>
                <label for="ingredient_name">Ingredient name:</label>
                <input name="ingredient_name" required>
                <label for="ingredient_quantity">Amount:</label>
                <input name="ingredient_quantity" type="number" required>
                <label for="ingredient_unit">Unit:</label>
                <input name="ingredient_unit">
                <button type="button">
                    <img width="12" height="12" src="img/delete-bin-64px.png" alt="Delete ingredient">
                </button>
            </li>
        </template>
        <template id="preparation_step">
            <li>
                <textarea cols="100" rows="1" class="recipePreparation"></textarea>
                <button type="button">
                    <img width="12" height="12" src="img/delete-bin-64px.png" alt="Delete ingredient">
                </button>
            </li>
        </template>
        <template id="pro_tip">
            <li>
                <textarea cols="100" rows="1" class="proTip"></textarea>
                <button type="button">
                    <img width="12" height="12" src="img/delete-bin-64px.png" alt="Delete ingredient">
                </button>
            </li>
        </template>
    </body>
</html>

<script>
    const form = document.getElementById("recipeForm");

    const ingredientList = document.getElementById("ingredient_list");
    const addIngredientButton = document.getElementById("add_ingredient_button");

    const preparations = document.getElementById("preparation");
    const preparationTemplate = document.querySelector('#preparation_step');
    const add_preparation_button = document.getElementById("add_preparation_button");

    const proTips = document.getElementById("pro_tips");
    const proTipTemplate = document.querySelector('#pro_tip');
    const addProTipButton = document.getElementById("add_pro_tip_button");

    function saveRecipe(event){
        event.preventDefault();
        let recipe = {};
        // Get recipe details
        recipeDetails = document.getElementsByClassName("recipeDetails");
        for (let recipeDetail of recipeDetails){
            recipe[recipeDetail.dataset.attribute_name] = recipeDetail.value;
        }
        // Get ingredients
        let ingredients = [];
        let ingredientsListItems = document.getElementById("ingredient_list").getElementsByTagName("li");
        for (let ingredientLi of ingredientsListItems) {
            let ingredientInputs = ingredientLi.getElementsByTagName("input");
            let ingredient = {};
            for (let ingredientInput of ingredientInputs) {
                if (ingredientInput.value !== "") {
                    ingredient[ingredientInput.name] = ingredientInput.value;
                }
            }
            ingredients.push(ingredient);
        }
        recipe["ingredients"] = ingredients;

        let result_div = document.getElementById("result");
        result_div.innerHTML = "Saving your recipe is not yet supported. Here's the JSON" + "<br>" + JSON.stringify(recipe);
    };

    function addIngredient(){
        let ingredient_template = document.querySelector('#ingredient');
        let clone = ingredient_template.content.cloneNode(true);
        // Add id to list item so it can be deleted.
        let ingredient_id = "ingredient_" + ingredientList.getElementsByTagName("li").length;
        clone.querySelector("li").id = ingredient_id;
        clone.querySelector("button").addEventListener("click", () => { deleteIngredient(ingredient_id); }, false);
        ingredientList.appendChild(clone);
    }

    function deleteIngredient(ingredient_id){
        let ingredientListItem = document.getElementById(ingredient_id);
        ingredientListItem.remove();
    }
    
    function addPreparationStep(){
        let clone = preparationTemplate.content.cloneNode(true);
        // Add id to list item so it can be deleted.
        let preparationId = "preparation_" + preparations.getElementsByTagName("li").length;
        clone.querySelector("li").id = preparationId;
        clone.querySelector("button").addEventListener("click", () => { deletePreparationStep(preparationId); }, false);
        preparations.appendChild(clone);
    }

    function deletePreparationStep(preparationId){
        let preparationListItem = document.getElementById(preparationId);
        preparationListItem.remove();
    }

    function addProTip(){
        let clone = proTipTemplate.content.cloneNode(true);
        // Add id to list item so it can be deleted.
        let proTipId = "pro_tip_" + preparations.getElementsByTagName("li").length;
        clone.querySelector("li").id = proTipId;
        clone.querySelector("button").addEventListener("click", () => { deleteProTip(proTipId); }, false);
        proTips.appendChild(clone);
    }

    function deleteProTip(proTipId){
        let proTipListItem = document.getElementById(proTipId);
        proTipListItem.remove();
    }

    addIngredient();
    addPreparationStep();
    addProTip();
    add_ingredient_button.addEventListener("click", addIngredient, false);
    add_preparation_button.addEventListener("click", addPreparationStep, false);
    addProTipButton.addEventListener("click", addProTip, false);
    form.addEventListener("submit", saveRecipe, false);
</script>